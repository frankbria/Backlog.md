name: Release multi-platform executables

on:
  push:
    tags: ['v*.*.*']

permissions:
  contents: write
  id-token: write

jobs:
  build:
    name: build-${{ matrix.target }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: bun-linux-x64-baseline
          - os: ubuntu-latest
            target: bun-linux-arm64
          - os: macos-latest
            target: bun-darwin-x64
          - os: macos-latest
            target: bun-darwin-arm64
          - os: windows-latest
            target: bun-windows-x64-baseline
    runs-on: ${{ matrix.os }}
    env:
      BIN: backlog-bin${{ contains(matrix.target,'windows') && '.exe' || '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v1
        with:
          # Bun >=1.3 includes stdin pause/subprocess handoff fixes used by TUI editor launch.
          bun-version: 1.3.9
      - uses: actions/cache@v4
        id: cache
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-${{ matrix.target }}-bun-1.3.9-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-bun-1.3.9-
      - run: bun install --frozen-lockfile
      - name: Sync version to tag
        shell: bash
        run: |
          TAG="${GITHUB_REF##refs/tags/v}"
          jq ".version = \"$TAG\"" package.json > tmp.json && mv tmp.json package.json
      - name: Prime Bun cache for baseline target (Windows workaround)
        if: ${{ contains(matrix.target, 'baseline') && contains(matrix.target, 'windows') }}
        shell: bash
        run: |
          # Workaround for https://github.com/oven-sh/bun/issues/13513
          # Build a dummy project from C:\ to prime the baseline binary cache
          cd /c
          mkdir -p bun-cache-primer
          cd bun-cache-primer
          echo 'console.log("cache primer")' > index.js
          bun build --compile --target=${{ matrix.target }} ./index.js --outfile primer.exe || true
          cd $GITHUB_WORKSPACE
      - name: Compile standalone binary
        shell: bash
        run: |
          mkdir -p dist
          bun build src/cli.ts --compile --minify --target=${{ matrix.target }} --define __EMBEDDED_VERSION__="\"${GITHUB_REF##refs/tags/v}\"" --outfile=dist/${{ env.BIN }}
      - name: Make binary executable (non-Windows)
        if: ${{ !contains(matrix.target,'windows') }}
        run: chmod +x "dist/${{ env.BIN }}"
      - name: Check build output and move binary
        shell: bash
        run: |
          echo "Contents of dist/:"
          ls -la dist/
          echo "Moving dist/${{ env.BIN }} to ${{ env.BIN }}"
          mv dist/${{ env.BIN }} ${{ env.BIN }}
          echo "Final binary size:"
          ls -lh ${{ env.BIN }}
      - uses: actions/upload-artifact@v4
        with:
          name: backlog-${{ matrix.target }}
          path: ${{ env.BIN }}

  npm-publish:
    needs: [build, verify-platform-packages]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Prepare npm package
        shell: bash
        run: |
          mkdir -p dist
          cp scripts/cli.cjs dist/cli.js
          cp scripts/resolveBinary.cjs dist/resolveBinary.cjs
          cp scripts/postuninstall.cjs dist/postuninstall.cjs
          chmod +x dist/cli.js
      - name: Create npm-ready package.json
        shell: bash
        run: |
          TAG="${GITHUB_REF##refs/tags/v}"
          jq 'del(.devDependencies,.scripts.prepare,.scripts.preinstall,.type) |
              .version = "'$TAG'" |
              .bin = {backlog:"cli.js"} |
              .files = ["cli.js","resolveBinary.cjs","postuninstall.cjs","package.json","README.md","LICENSE"] |
              .scripts = {"postuninstall": "node postuninstall.cjs"} |
              .repository = {"type":"git","url":"https://github.com/MrLesk/Backlog.md"} |
              .optionalDependencies = {
                "backlog.md-linux-x64"  : "'$TAG'",
                "backlog.md-linux-arm64": "'$TAG'",
                "backlog.md-darwin-x64" : "'$TAG'",
                "backlog.md-darwin-arm64": "'$TAG'",
                "backlog.md-windows-x64": "'$TAG'"
              }' package.json > dist/package.json
          cp LICENSE README.md dist/ 2>/dev/null || true
      - uses: actions/setup-node@v5
        with:
          node-version: 24
      - name: Configure npm for trusted publishing
        shell: bash
        run: |
          set -euo pipefail
          npm install -g npm@11.6.0
          npm --version
      - name: Dry run trusted publish
        run: |
          cd dist
          npm publish --access public --dry-run
      - name: Publish to npm
        run: |
          cd dist
          npm publish --access public

  publish-binaries:
    needs: build
    strategy:
      matrix:
        include:
          - target: bun-linux-x64-baseline
            package: backlog.md-linux-x64
            os: linux
            cpu: x64
          - target: bun-linux-arm64
            package: backlog.md-linux-arm64
            os: linux
            cpu: arm64
          - target: bun-darwin-x64
            package: backlog.md-darwin-x64
            os: darwin
            cpu: x64
          - target: bun-darwin-arm64
            package: backlog.md-darwin-arm64
            os: darwin
            cpu: arm64
          - target: bun-windows-x64-baseline
            package: backlog.md-windows-x64
            os: win32
            cpu: x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: backlog-${{ matrix.target }}
        timeout-minutes: 15
      - name: Prepare package
        shell: bash
        run: |
          TAG="${GITHUB_REF##refs/tags/v}"
          mkdir -p pkg
          # Rename the binary to the expected name
          if [[ -f backlog-bin.exe ]]; then
            mv backlog-bin.exe pkg/backlog.exe
          elif [[ -f backlog-bin ]]; then
            mv backlog-bin pkg/backlog
          else
            echo "Error: No binary found"
            ls -la
            exit 1
          fi
          cp LICENSE README.md pkg/ 2>/dev/null || true
          cat <<EOF > pkg/package.json
          {
            "name": "${{ matrix.package }}",
            "version": "${TAG}",
            "os": ["${{ matrix.os }}"],
            "cpu": ["${{ matrix.cpu }}"],
            "files": ["backlog${{ contains(matrix.target,'windows') && '.exe' || '' }}","package.json","LICENSE"],
            "repository": {
              "type": "git",
              "url": "https://github.com/MrLesk/Backlog.md"
            }
          }
          EOF
      - name: Ensure executable permission (non-Windows)
        if: ${{ !contains(matrix.target,'windows') }}
        shell: bash
        run: |
          chmod +x pkg/backlog
      - uses: actions/setup-node@v5
        with:
          node-version: 24
      - name: Configure npm for trusted publishing
        shell: bash
        run: |
          set -euo pipefail
          npm install -g npm@11.6.0
          npm --version
      - name: Dry run platform publish
        run: |
          cd pkg
          npm publish --access public --dry-run
      - name: Publish platform package
        run: |
          cd pkg
          npm publish --access public

  verify-platform-packages:
    name: verify-platform-packages-${{ matrix.os }}
    needs: publish-binaries
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/setup-node@v5
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org
      - name: Wait for platform package installability (Unix)
        if: ${{ matrix.os != 'windows-latest' }}
        shell: bash
        run: |
          set -uo pipefail
          VERSION="${GITHUB_REF##refs/tags/v}"
          MAX_ATTEMPTS=40
          SLEEP_SECONDS=15
          PACKAGE_NAME="$(node -e 'const map = { win32: "windows", darwin: "darwin", linux: "linux" }; const platform = map[process.platform]; const arch = process.arch; if (!platform || !["x64","arm64"].includes(arch)) { process.exit(1); } process.stdout.write(`backlog.md-${platform}-${arch}`);')"
          BINARY_PATH="node_modules/${PACKAGE_NAME}/backlog"

          echo "Waiting for ${PACKAGE_NAME}@${VERSION} to become installable..."
          for attempt in $(seq 1 "$MAX_ATTEMPTS"); do
            rm -rf sanity
            mkdir sanity
            cd sanity
            npm init -y >/dev/null 2>&1

            if npm i "${PACKAGE_NAME}@${VERSION}" --prefer-online --no-audit --no-fund; then
              if [[ -f "$BINARY_PATH" ]]; then
                if "./$BINARY_PATH" -v; then
                  echo "Resolved ${PACKAGE_NAME}@${VERSION} on attempt ${attempt}/${MAX_ATTEMPTS}."
                  exit 0
                fi
              fi
            fi

            echo "Attempt ${attempt}/${MAX_ATTEMPTS} failed for ${PACKAGE_NAME}@${VERSION}."
            npm ls --depth=1 || true
            ls -la node_modules || true
            cd ..

            if [[ "$attempt" -lt "$MAX_ATTEMPTS" ]]; then
              sleep "$SLEEP_SECONDS"
            fi
          done

          echo "Timed out waiting for ${PACKAGE_NAME}@${VERSION}."
          exit 1
      - name: Wait for all platform package metadata (Linux only)
        if: ${{ matrix.os == 'ubuntu-latest' }}
        shell: bash
        run: |
          set -uo pipefail
          VERSION="${GITHUB_REF##refs/tags/v}"
          MAX_ATTEMPTS=40
          SLEEP_SECONDS=15
          PACKAGES=(
            "backlog.md-linux-x64"
            "backlog.md-linux-arm64"
            "backlog.md-darwin-x64"
            "backlog.md-darwin-arm64"
            "backlog.md-windows-x64"
          )

          for pkg in "${PACKAGES[@]}"; do
            resolved=0
            for attempt in $(seq 1 "$MAX_ATTEMPTS"); do
              version="$(npm view "${pkg}@${VERSION}" version 2>/dev/null || true)"
              if [[ "$version" == "$VERSION" ]]; then
                echo "Metadata visible: ${pkg}@${VERSION} (attempt ${attempt}/${MAX_ATTEMPTS})."
                resolved=1
                break
              fi

              echo "Attempt ${attempt}/${MAX_ATTEMPTS} metadata miss for ${pkg}@${VERSION}."
              if [[ "$attempt" -lt "$MAX_ATTEMPTS" ]]; then
                sleep "$SLEEP_SECONDS"
              fi
            done

            if [[ "$resolved" -ne 1 ]]; then
              echo "Timed out waiting for metadata: ${pkg}@${VERSION}."
              exit 1
            fi
          done
      - name: Wait for platform package installability (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $Version = $env:GITHUB_REF_NAME.TrimStart("v")
          $MaxAttempts = 40
          $SleepSeconds = 15
          $Arch = [System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture.ToString().ToLowerInvariant()
          if ($Arch -ne "x64" -and $Arch -ne "arm64") {
            throw "Unsupported runner arch: $Arch"
          }

          $PackageName = "backlog.md-windows-$Arch"
          $BinaryPath = Join-Path -Path "node_modules/$PackageName" -ChildPath "backlog.exe"

          Write-Host "Waiting for $PackageName@$Version to become installable..."
          for ($attempt = 1; $attempt -le $MaxAttempts; $attempt++) {
            if (Test-Path "sanity") {
              Remove-Item -Recurse -Force "sanity"
            }
            New-Item -ItemType Directory -Path "sanity" | Out-Null
            Push-Location "sanity"

            try {
              npm init -y | Out-Null
              npm i "$PackageName@$Version" --prefer-online --no-audit --no-fund
              if ($LASTEXITCODE -eq 0 -and (Test-Path $BinaryPath)) {
                & $BinaryPath -v
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "Resolved $PackageName@$Version on attempt $attempt/$MaxAttempts."
                  exit 0
                }
              }

              Write-Host "Attempt $attempt/$MaxAttempts failed for $PackageName@$Version."
              npm ls --depth=1 | Out-Host
              if (Test-Path node_modules) {
                Get-ChildItem node_modules | Out-Host
              }
            } finally {
              Pop-Location
            }

            if ($attempt -lt $MaxAttempts) {
              Start-Sleep -Seconds $SleepSeconds
            }
          }

          throw "Timed out waiting for $PackageName@$Version."

  install-sanity:
    name: install-sanity-${{ matrix.os }}
    needs: [publish-binaries, npm-publish]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/setup-node@v5
        with:
          node-version: 24
          registry-url: https://registry.npmjs.org
      - name: Install and run backlog -v (Unix)
        if: ${{ matrix.os != 'windows-latest' }}
        shell: bash
        run: |
          set -uo pipefail
          VERSION="${GITHUB_REF##refs/tags/v}"
          MAX_ATTEMPTS=40
          SLEEP_SECONDS=15
          EXPECTED_PACKAGE="$(node -e 'const map = { win32: "windows", darwin: "darwin", linux: "linux" }; const platform = map[process.platform]; const arch = process.arch; if (!platform || !["x64","arm64"].includes(arch)) { process.exit(1); } process.stdout.write(`backlog.md-${platform}-${arch}`);')"
          echo "Waiting for backlog.md@${VERSION} install + ${EXPECTED_PACKAGE} optional dependency..."

          for attempt in $(seq 1 "$MAX_ATTEMPTS"); do
            rm -rf sanity
            mkdir sanity
            cd sanity
            npm init -y >/dev/null 2>&1

            if npm i "backlog.md@${VERSION}" --prefer-online --no-audit --no-fund; then
              if npx backlog -v; then
                echo "Install sanity succeeded on attempt ${attempt}/${MAX_ATTEMPTS}."
                exit 0
              fi
            fi

            echo "Attempt ${attempt}/${MAX_ATTEMPTS} failed."
            echo "Expected optional package: ${EXPECTED_PACKAGE}"
            npm ls --depth=1 || true
            if [[ -d "node_modules/${EXPECTED_PACKAGE}" ]]; then
              echo "Optional package directory exists: node_modules/${EXPECTED_PACKAGE}"
            else
              echo "Optional package directory missing: node_modules/${EXPECTED_PACKAGE}"
            fi
            cd ..

            if [[ "$attempt" -lt "$MAX_ATTEMPTS" ]]; then
              sleep "$SLEEP_SECONDS"
            fi
          done

          echo "Install sanity timed out for backlog.md@${VERSION}."
          exit 1
      - name: Install and run backlog -v (Windows)
        if: ${{ matrix.os == 'windows-latest' }}
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $Version = $env:GITHUB_REF_NAME.TrimStart("v")
          $MaxAttempts = 40
          $SleepSeconds = 15
          $Arch = [System.Runtime.InteropServices.RuntimeInformation]::OSArchitecture.ToString().ToLowerInvariant()
          if ($Arch -ne "x64" -and $Arch -ne "arm64") {
            throw "Unsupported runner arch: $Arch"
          }

          $ExpectedPackage = "backlog.md-windows-$Arch"
          Write-Host "Waiting for backlog.md@$Version install + $ExpectedPackage optional dependency..."

          for ($attempt = 1; $attempt -le $MaxAttempts; $attempt++) {
            if (Test-Path "sanity") {
              Remove-Item -Recurse -Force "sanity"
            }
            New-Item -ItemType Directory -Path "sanity" | Out-Null
            Push-Location "sanity"

            try {
              npm init -y | Out-Null
              npm i "backlog.md@$Version" --prefer-online --no-audit --no-fund
              if ($LASTEXITCODE -eq 0) {
                npx backlog -v
                if ($LASTEXITCODE -eq 0) {
                  Write-Host "Install sanity succeeded on attempt $attempt/$MaxAttempts."
                  exit 0
                }
              }

              Write-Host "Attempt $attempt/$MaxAttempts failed."
              Write-Host "Expected optional package: $ExpectedPackage"
              npm ls --depth=1 | Out-Host
              if (Test-Path "node_modules/$ExpectedPackage") {
                Write-Host "Optional package directory exists: node_modules/$ExpectedPackage"
              } else {
                Write-Host "Optional package directory missing: node_modules/$ExpectedPackage"
              }
            } finally {
              Pop-Location
            }

            if ($attempt -lt $MaxAttempts) {
              Start-Sleep -Seconds $SleepSeconds
            }
          }

          throw "Install sanity timed out for backlog.md@$Version."

  github-release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release-assets
        timeout-minutes: 15
      - name: Rename binaries for release
        run: |
          echo "=== Debug: Downloaded artifacts ==="
          find release-assets -type f -exec ls -lh {} \;
          echo "=== Processing artifacts ==="
          mkdir -p binaries
          for dir in release-assets/*/; do
            if [ -d "$dir" ]; then
              target=$(basename "$dir" | sed 's/backlog-//')
              echo "Processing target: $target"
              echo "Directory contents:"
              ls -la "$dir"
              binary=$(find "$dir" -name "backlog-bin*" -type f)
              if [ -n "$binary" ]; then
                echo "Found binary: $binary ($(ls -lh "$binary" | awk '{print $5}'))"
                if [[ "$target" == *"windows"* ]] && [[ "$binary" == *".exe" ]]; then
                  cp "$binary" "binaries/backlog-${target}.exe"
                  echo "Copied to binaries/backlog-${target}.exe ($(ls -lh "binaries/backlog-${target}.exe" | awk '{print $5}'))"
                else
                  cp "$binary" "binaries/backlog-${target}"
                  echo "Copied to binaries/backlog-${target} ($(ls -lh "binaries/backlog-${target}" | awk '{print $5}'))"
                fi
              fi
            fi
          done
          echo "=== Final binaries ==="
          ls -lh binaries/
      - uses: softprops/action-gh-release@v1
        with:
          files: binaries/*
